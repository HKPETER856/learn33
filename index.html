<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>第三教室｜研学旅行</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box;}
  :root{
    --primary:#0f6c74;        /* 青色主色 */
    --primary-dark:#084c52;   /* 深青 */
    --primary-light:#1b8a94;  /* 亮青点缀 */
    --sand:#f7f6f2;           /* 暖米底色：旅游气质 */
    --paper:#ffffff;
    --line:#e9e3d8;
    --text:#2a2f36;
    --muted:#616a77;
    --shadow:0 10px 24px rgba(0,0,0,.06);
    --shadow2:0 14px 32px rgba(15,108,116,.14);
    --radius:14px;
    --max:1120px;
  }
  body{
    font-family:"PingFang SC","Microsoft YaHei",system-ui,-apple-system,Segoe UI,Arial,sans-serif;
    color:var(--text);
    line-height:1.65;
    background:
      radial-gradient(circle at 18% 0%, rgba(15,108,116,0.08), transparent 38%),
      radial-gradient(circle at 82% 100%, rgba(15,108,116,0.06), transparent 48%),
      var(--sand);
  }
  a{text-decoration:none;color:inherit;}
  img{display:block; max-width:100%;}
  .container{
    max-width:var(--max);
    margin:0 auto;
    padding:0 20px;
  }
  /* ===== 顶部导航（响应式） ===== */
  header{
    position:sticky;
    top:0;
    z-index:50;
    background:rgba(247,246,242,.86);
    backdrop-filter:blur(10px);
    border-bottom:1px solid var(--line);
  }
  .nav{
    height:72px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:14px;
  }
  .brand{
    display:flex;
    align-items:center;
    gap:12px;
    min-width:180px;
  }
  .mark{
    width:40px;height:40px;border-radius:12px;
    display:grid;place-items:center;
    background:linear-gradient(135deg, var(--primary-dark), var(--primary));
    color:#fff;
    font-weight:700;
    letter-spacing:.5px;
    box-shadow:0 10px 22px rgba(15,108,116,.18);
  }
  .brand .title{
    display:flex;
    flex-direction:column;
    line-height:1.15;
  }
  .brand strong{font-size:18px;color:var(--primary-dark);}
  .brand span{font-size:12px;color:var(--muted);}
  /* desktop nav links */
  nav{
    display:flex;
    align-items:center;
    gap:22px;
  }
  nav a{
    font-size:15px;
    color:#49515f;
    padding:8px 10px;
    border-radius:10px;
    transition:.2s ease;
  }
  nav a:hover{
    color:var(--primary-dark);
    background:rgba(255,255,255,.75);
    box-shadow:0 8px 18px rgba(0,0,0,.05);
  }
  /* mobile menu button */
  .menu-btn{
    display:none;
    width:42px;height:42px;
    border-radius:12px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.75);
    cursor:pointer;
    align-items:center;
    justify-content:center;
    gap:5px;
  }
  .menu-btn span{
    display:block;
    width:18px;height:2px;
    background:var(--primary-dark);
    border-radius:2px;
  }
  /* mobile drawer */
  .mobile-nav{
    display:none;
    border-top:1px solid var(--line);
    background:rgba(255,255,255,.72);
    backdrop-filter:blur(10px);
  }
  .mobile-nav .inner{
    padding:10px 0 14px;
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .mobile-nav a{
    padding:10px 12px;
    border-radius:12px;
    color:#404958;
    border:1px solid transparent;
  }
  .mobile-nav a:hover{
    border-color:rgba(15,108,116,.20);
    background:rgba(15,108,116,.06);
    color:var(--primary-dark);
  }
  /* ===== 宣传语（简洁，无右侧） ===== */
  .hero{
    padding:66px 0 26px;
  }
  .hero-box{
    background:linear-gradient(135deg, rgba(230,244,245,1), rgba(255,255,255,1) 72%);
    border:1px solid var(--line);
    border-radius:calc(var(--radius) + 6px);
    box-shadow:var(--shadow);
    overflow:hidden;
  }
  .hero-inner{
    padding:34px 26px 30px;
    text-align:center;
  }
  .kicker{
    display:inline-flex;
    align-items:center;
    gap:10px;
    font-size:12px;
    color:var(--muted);
    letter-spacing:.2px;
  }
  .dot{
    width:8px;height:8px;border-radius:50%;
    background:linear-gradient(135deg, var(--primary), var(--primary-light));
    display:inline-block;
  }
  .hero h1{
    margin:12px 0 12px;
    font-size:34px;
    color:var(--primary-dark);
    letter-spacing:.6px;
  }
  .hero p{
    margin:0 auto;
    font-size:16px;
    color:#4a525f;
    max-width:860px;
  }
  /* ===== 板块与卡片（响应式栅格） ===== */
  .section{padding:64px 0;}
  .section.alt{
    background:linear-gradient(135deg, rgba(238,246,247,1), rgba(255,255,255,1) 80%);
    border-top:1px solid rgba(233,227,216,.65);
    border-bottom:1px solid rgba(233,227,216,.65);
  }
  .section h2{
    text-align:center;
    font-size:24px;
    color:var(--primary-dark);
    margin-bottom:44px;
    position:relative;
    letter-spacing:.4px;
  }
  .section h2::after{
    content:"";
    width:56px;
    height:3px;
    background:linear-gradient(to right, var(--primary-dark), var(--primary-light));
    display:block;
    margin:14px auto 0;
    border-radius:2px;
    opacity:.95;
  }
  .cards{
    display:grid;
    grid-template-columns:repeat(3, 1fr);
    gap:16px;
  }
  .card{
    background:var(--paper);
    border:1px solid var(--line);
    border-radius:var(--radius);
    overflow:hidden;
    box-shadow:0 10px 22px rgba(0,0,0,.05);
    transition:.25s ease;
  }
  .card:hover{
    transform:translateY(-6px);
    box-shadow:var(--shadow2);
  }
  .card img{
    width:100%;
    height:190px;
    object-fit:cover;
    background: #efece5;
  }
  .card h3{
    padding:16px 16px 18px;
    font-size:16px;
    color:#2a3442;
  }
  .more{
    text-align:center;
    margin-top:34px;
  }
  .more a{
    display:inline-block;
    padding:10px 16px;
    border-radius:999px;
    border:1px solid rgba(15,108,116,.22);
    background:rgba(255,255,255,.75);
    color:var(--primary-dark);
    font-weight:600;
    transition:.2s ease;
  }
  .more a:hover{
    transform:translateY(-1px);
    box-shadow:var(--shadow);
    background:#fff;
  }
  /* ===== 广告语 ===== */
  .slogan{
    padding:62px 0;
    text-align:center;
    background:
      radial-gradient(circle at center, rgba(15,108,116,0.09), transparent 60%);
  }
  .slogan .bar{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:10px;
    padding:14px 18px;
    border-radius:999px;
    background:rgba(255,255,255,.80);
    border:1px solid var(--line);
    box-shadow:var(--shadow);
    color:var(--primary-dark);
    font-size:18px;
    font-weight:600;
    letter-spacing:1.2px;
  }
  .slogan .bar::before{
    content:"";
    width:10px;height:10px;border-radius:50%;
    background:linear-gradient(135deg, var(--primary), var(--primary-light));
    display:inline-block;
  }
  /* ===== 底部 ===== */
  footer{
    background:linear-gradient(135deg, var(--primary-dark), var(--primary));
    color:#fff;
    padding:34px 0;
    text-align:center;
    font-size:14px;
    letter-spacing:.6px;
  }
  /* ===== 响应式断点 ===== */
  /* 平板 */
  @media (max-width: 920px){
    .hero h1{font-size:30px;}
    .cards{grid-template-columns:repeat(2, 1fr);}
    nav{gap:12px;}
    nav a{padding:8px 8px;}
  }
  /* 手机 */
  @media (max-width: 640px){
    .nav{height:68px;}
    nav{display:none;}           /* 隐藏桌面导航 */
    .menu-btn{display:flex;}     /* 显示汉堡按钮 */
    .hero{padding:52px 0 18px;}
    .hero-inner{padding:26px 18px 24px;}
    .hero h1{font-size:24px; line-height:1.35;}
    .hero p{font-size:15px;}
    .section{padding:52px 0;}
    .section h2{font-size:20px; margin-bottom:30px;}
    .cards{grid-template-columns:1fr;}
    .card img{height:180px;}
    footer{font-size:13px; padding:28px 0;}
  }

  /* ===== 研学目的地分页 ===== */
  .pager{
    margin-top:18px;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:12px;
  }
  .pg-btn{
    padding:10px 14px;
    border-radius:999px;
    border:1px solid rgba(15,108,116,.22);
    background:rgba(255,255,255,.75);
    color:var(--primary-dark);
    font-weight:600;
    cursor:pointer;
    transition:.2s ease;
  }
  .pg-btn:hover{
    transform:translateY(-1px);
    box-shadow:var(--shadow);
    background:#fff;
  }
  .pg-btn:disabled{
    opacity:.45;
    cursor:not-allowed;
    transform:none;
    box-shadow:none;
  }
  .pg-info{
    font-size:13px;
    color:var(--muted);
    min-width:120px;
    text-align:center;
  }

  /* ===== 研学目的地信息速览卡片 ===== */
  .dest-card{ overflow:hidden; }
  .dest-img{ width:100%; aspect-ratio: 4 / 3; overflow:hidden; background:#f3f5f6; }
  .dest-img img{ width:100%; height:100%; object-fit:cover; display:block; }
  .dest-body{ padding:14px 14px 16px; }
  .dest-title{ display:flex; align-items:baseline; justify-content:space-between; gap:10px; }
  .dest-title h3{ margin:0; font-size:16px; line-height:1.25; }
  .dest-loc{ font-size:12px; color:var(--muted); white-space:nowrap; }
  .dest-meta{ margin-top:10px; display:flex; flex-wrap:wrap; gap:8px; }
  .tag{
    display:inline-flex;
    align-items:center;
    padding:6px 10px;
    border-radius:999px;
    font-size:12px;
    font-weight:600;
    border:1px solid rgba(15,108,116,.22);
    color:var(--primary-dark);
    background:rgba(15,108,116,.06);
  }
  .tag-soft{
    border-color: rgba(0,0,0,.08);
    color:#2c3e50;
    background:rgba(0,0,0,.04);
  }
  .dest-summary{
    margin:10px 0 0;
    font-size:13px;
    color:#3c4a55;
    line-height:1.55;
    display:-webkit-box;
    -webkit-line-clamp:2;
    -webkit-box-orient:vertical;
    overflow:hidden;
  }

  /* ===== 研学目的地信息速览 ===== */
  #destGrid .card{
    display:flex;
    flex-direction:column;
    overflow:hidden;
  }
  #destGrid .card img{
    width:100%;
    height:160px;
    object-fit:cover;
  }
  #destGrid .card .card-body{
    padding:12px 14px 14px;
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  #destGrid .card h3{
    margin:0;
    font-size:16px;
    line-height:1.25;
    color:var(--primary-dark);
  }
  #destGrid .meta{
    display:flex;
    flex-wrap:wrap;
    gap:6px;
  }
  #destGrid .tag{
    font-size:12px;
    padding:4px 8px;
    border-radius:999px;
    border:1px solid rgba(15,108,116,.18);
    background:rgba(15,108,116,.06);
    color:var(--primary-dark);
    white-space:nowrap;
  }
  #destGrid .desc{
    margin:0;
    font-size:13px;
    line-height:1.55;
    color:var(--muted);
  }

  /* 目的地卡片跳转链接 */
  .card-link{ text-decoration:none; color:inherit; display:block; }
  .card-link:focus-visible{ outline:3px solid rgba(15,108,116,.35); outline-offset:6px; border-radius:18px; }

  /* ===== Filters & search ===== */
  .filters{margin:18px 0 10px}
  .filter-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center}
  .search{min-width:220px;flex:1 1 240px;max-width:460px;border:1px solid #d7dde6;border-radius:999px;padding:10px 14px;font-size:14px;outline:none;background:#fff}
  .search:focus{border-color:#0a6b73;box-shadow:0 0 0 3px rgba(10,107,115,.12)}
  .select{border:1px solid #d7dde6;border-radius:999px;padding:10px 12px;font-size:14px;background:#fff;outline:none}
  .select:focus{border-color:#0a6b73;box-shadow:0 0 0 3px rgba(10,107,115,.12)}
  .btn-clear{border:1px solid #d7dde6;border-radius:999px;background:#fff;padding:10px 14px;font-size:14px;cursor:pointer}
  .btn-clear:hover{border-color:#0a6b73}
  .filter-hint{margin-top:10px;text-align:center;color:#5b6576;font-size:13px}
  .data-error{margin:12px auto 0;max-width:900px;background:#fff3f3;border:1px solid #ffd1d1;color:#9b1c1c;padding:10px 12px;border-radius:12px;text-align:center}
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

  /* ===== 目的地列表：单列 + 行式展示（每行 1 个目的地） ===== */
  #destGrid.cards{ grid-template-columns:1fr !important; }
  #destGrid .card{
    display:flex;
    flex-direction:row;
    gap:14px;
    align-items:stretch;
    overflow:hidden;
  }
  #destGrid .card img{
    width:240px;
    height:170px;
    flex:0 0 240px;
    object-fit:cover;
  }
  #destGrid .card .card-body{
    padding:14px 14px 16px;
    display:flex;
    flex-direction:column;
    gap:10px;
    flex:1 1 auto;
  }
  #destGrid .desc{ display:none; } /* 原 summary 不再单独展示 */

  .intro{
    margin:0;
    font-size:13px;
    line-height:1.6;
    color:#44525c;
  }
  .themes{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin-top:2px;
  }
  .theme-tag{
    display:inline-flex;
    align-items:center;
    padding:6px 10px;
    border-radius:999px;
    font-size:12px;
    font-weight:700;
    border:1px solid rgba(15,108,116,.18);
    background:rgba(15,108,116,.08);
    color:var(--primary-dark);
    white-space:nowrap;
  }

  /* 手机端：图片上方，内容下方 */
  @media (max-width: 640px){
    #destGrid .card{ flex-direction:column; }
    #destGrid .card img{
      width:100%;
      flex:0 0 auto;
      height:180px;
    }
  }

</style>
</head>
<body>
<!-- ===== 导航 ===== -->
<header>
  <div class="container nav">
    <div class="brand">
      <div class="mark">Ⅲ</div>
      <div class="title">
        <strong>第三教室</strong>
      </div>
    </div>
    <!-- 桌面导航 -->
    <nav aria-label="主导航">
      <a href="#">首页</a>
      <a href="#dest">研学目的地</a>
            <a href="#">关于</a>
    </nav>
    <!-- 手机端汉堡按钮 -->
    <button class="menu-btn" id="menuBtn" aria-label="打开菜单" aria-expanded="false" aria-controls="mobileNav">
      <span></span><span></span><span></span>
    </button>
  </div>
  <!-- 手机端下拉菜单 -->
  <div class="mobile-nav" id="mobileNav" hidden>
    <div class="container inner">
      <a href="#">首页</a>
      <a href="#dest">研学目的地</a>
            <a href="#">关于</a>
    </div>
  </div>
</header>
<!-- ===== 宣传语 ===== -->
<section class="hero">
  <div class="container">
    <div class="hero-box">
      <div class="hero-inner">
        <h1>把世界当作课堂，把体验变成成长</h1>
        <p>
          研学旅行是第三教室，
          以自然、人文与社会为课堂，
          通过真实体验、项目探究与团队协作，
          让孩子在行走中学习，在探索中成长。
        </p>
      </div>
    </div>
  </div>
</section>
<!-- ===== 研学目的地（可更新 + 分页） ===== -->
<section class="section" id="dest">
  <div class="container">
    <h2>热门研学目的地</h2>

    <!-- 筛选与搜索 -->
    <div class="filters" aria-label="目的地筛选">
      <div class="filter-row">
        <label class="sr-only" for="searchInput">搜索</label>
        <input id="searchInput" class="search" type="search" placeholder="搜索目的地/城市/类型…" autocomplete="off" />

        <label class="sr-only" for="filterCity">城市</label>
        <select id="filterCity" class="select">
          <option value="">全部城市</option>
        </select>

        <label class="sr-only" for="filterType">类型</label>
        <select id="filterType" class="select">
          <option value="">全部类型</option>
        </select>

        <label class="sr-only" for="filterStage">学段</label>
        <select id="filterStage" class="select">
          <option value="">全部学段</option>
        </select>

        <button id="clearFilters" class="btn-clear" type="button">清空</button>
      </div>
      <div class="filter-hint" id="filterHint" aria-live="polite"></div>
    </div>

    <!-- 数据加载失败提示 -->
    <div class="data-error" id="dataError" hidden></div>

    <!-- 可更新数据将由下方 JS 渲染到这里 -->
    <div class="cards" id="destGrid"></div>

    <!-- 分页（超过 4 行自动分页） -->
    <div class="pager" id="destPager" aria-label="研学目的地分页" hidden>
      <button class="pg-btn" id="pgPrev" type="button" aria-label="上一页">上一页</button>
      <div class="pg-info" id="pgInfo" aria-live="polite"></div>
      <button class="pg-btn" id="pgNext" type="button" aria-label="下一页">下一页</button>
    </div>

  </div>
</section>

<!-- ===== 广告语 ===== -->
<section class="slogan">
  <div class="container">
    <div class="bar">让世界成为课本，让探索唤醒热爱。
    </div>
  </div>
</section>
<!-- ===== 底部 ===== -->
<footer>
  © 2026 第三教室 ｜ 联系电话：暂无 ｜ 地址：暂无
</footer>

<script>
  // data file loading error handler
  window.__destDataLoadFailed = function(e){
    console.error("Failed to load ./data/destinations.js", e);
    const box = document.getElementById("dataError");
    if (box){ box.hidden = false; box.textContent = "数据文件加载失败：请确认 ./data/destinations.js 路径存在，且与本 HTML 的目录结构一致。"; }
  };
</script>
<script src="./data/destinations.js" onerror="window.__destDataLoadFailed && window.__destDataLoadFailed(event)"></script>
<script>
  // 手机端菜单开关（无依赖）
  const btn = document.getElementById('menuBtn');
  const nav = document.getElementById('mobileNav');
  btn.addEventListener('click', () => {
    const isOpen = !nav.hasAttribute('hidden');
    if (isOpen) {
      nav.setAttribute('hidden', '');
      btn.setAttribute('aria-expanded', 'false');
    } else {
      nav.removeAttribute('hidden');
      btn.setAttribute('aria-expanded', 'true');
    }
  });
  // 点击菜单项后自动收起（更像真实站点）
  nav.addEventListener('click', (e) => {
    if (e.target.tagName.toLowerCase() === 'a') {
      nav.setAttribute('hidden', '');
      btn.setAttribute('aria-expanded', 'false');
    }
  });

  // ===== 研学目的地（数据来自 ./data/destinations.js） =====
  // ✅ 后续只需要维护 ./data/destinations.js 内的 window.DESTINATIONS 数组
// Data is loaded from ./data/destinations.js (single source of truth)
  const destinations = (window.DESTINATIONS || []);

  const dataError = document.getElementById('dataError');
  const filterCity = document.getElementById('filterCity');
  const filterType = document.getElementById('filterType');
  const filterStage = document.getElementById('filterStage');
  const searchInput = document.getElementById('searchInput');
  const clearFilters = document.getElementById('clearFilters');
  const filterHint = document.getElementById('filterHint');

  function showDataError(msg){
    console.error(msg);
    if (dataError){ dataError.hidden = false; dataError.textContent = msg; }
  }

  function uniq(arr){ return Array.from(new Set(arr.filter(Boolean))); }
  function fillSelect(selectEl, values, placeholder){
    if (!selectEl) return;
    const current = selectEl.value;
    selectEl.innerHTML = '';
    const opt0 = document.createElement('option');
    opt0.value = '';
    opt0.textContent = placeholder;
    selectEl.appendChild(opt0);
    values.forEach(v => {
      const opt = document.createElement('option');
      opt.value = v;
      opt.textContent = v;
      selectEl.appendChild(opt);
    });
    // try restore
    if (current) selectEl.value = current;
  }

  function initFilters(){
    if (!destinations || destinations.length === 0) {
      showDataError('没有读取到目的地数据：请确认 ./data/destinations.js 中 window.DESTINATIONS 有内容。');
      return;
    }
    const cities = uniq(destinations.map(d => d.provinceCity)).sort();
    const types = uniq(destinations.map(d => d.type)).sort();
    const stages = uniq(destinations.map(d => d.stage)).sort();
    fillSelect(filterCity, cities, '全部城市');
    fillSelect(filterType, types, '全部类型');
    fillSelect(filterStage, stages, '全部学段');
  }

  function getFilterState(){
    return {
      q: (searchInput?.value || '').trim().toLowerCase(),
      city: filterCity?.value || '',
      type: filterType?.value || '',
      stage: filterStage?.value || ''
    };
  }

  function getFilteredIndices(){
    const s = getFilterState();
    const indices = [];
    for (let i = 0; i < destinations.length; i++) {
      const d = destinations[i] || {};
      if (s.city && d.provinceCity !== s.city) continue;
      if (s.type && d.type !== s.type) continue;
      if (s.stage && d.stage !== s.stage) continue;
      if (s.q) {
        const hay = `${d.name||''} ${d.provinceCity||''} ${d.type||''} ${d.stage||''} ${d.summary||''}`.toLowerCase();
        if (!hay.includes(s.q)) continue;
      }
      indices.push(i);
    }
    return indices;
  }

  // ===== 目的地展示补充：50字简介 + 3个研学活动主题（若数据未提供则自动生成） =====
  function clampCN(text, maxChars){
    const t = String(text || '').replace(/\s+/g,'').trim();
    if (t.length <= maxChars) return t;
    return t.slice(0, Math.max(0, maxChars-1)) + '…';
  }

  function buildIntro(d){
    // 优先使用数据里的 intro（若未来在 destinations.js 中提供）
    const raw = (d && (d.intro || d.brief || d.overview)) ? (d.intro || d.brief || d.overview) : '';
    if (raw) return clampCN(raw, 50);
    const base = `${d.name||'该目的地'}位于${d.provinceCity||'当地'}，以${d.type||'实践探究'}为主线，融合任务挑战与团队协作，带孩子在行走中发现问题、动手解决、收获成长。`;
    return clampCN(base + '欢迎来探索。', 50);
  }

  function buildThemes(d){
    // 优先使用数据里的 themes（数组或逗号分隔字符串）
    const raw = d && d.themes;
    if (Array.isArray(raw) && raw.length) return raw.slice(0,3).map(s=>String(s).trim()).filter(Boolean);
    if (typeof raw === 'string' && raw.trim()){
      return raw.split(/[,，\n]/).map(s=>s.trim()).filter(Boolean).slice(0,3);
    }

    const t = String(d?.type || '').toLowerCase();
    if (t.includes('自然') || t.includes('生态') || t.includes('地质')){
      return ['雨林/山野探秘任务', '星空与自然观察营', '生态守护行动挑战'];
    }
    if (t.includes('科技') || t.includes('科创') || t.includes('工业')){
      return ['未来实验室挑战赛', '工程师拆解与复盘', 'AI创想作品发布会'];
    }
    if (t.includes('人文') || t.includes('历史') || t.includes('博物') || t.includes('文化')){
      return ['时空穿越情境剧本', '博物馆寻宝研读', '非遗匠心体验课'];
    }
    if (t.includes('红色') || t.includes('国防') || t.includes('爱国')){
      return ['红色足迹定向打卡', '小小讲解员训练营', '使命任务协作挑战'];
    }
    if (t.includes('海洋') || t.includes('航海') || t.includes('海岛')){
      return ['海岸线科考记录', '潮间带生物观察', '帆船/航海素养课堂'];
    }
    return ['城市定向闯关赛', '小小研究员项目', '团队领导力营地'];
  }

const destGrid = document.getElementById('destGrid');
  const destPager = document.getElementById('destPager');
  const pgPrev = document.getElementById('pgPrev');
  const pgNext = document.getElementById('pgNext');
  const pgInfo = document.getElementById('pgInfo');

  let currentPage = 1;
  let pageSize = 12; // 默认值，会在计算列数后重算：列数 * 4 行

  function getGridColumns() {
    // 通过计算 grid-template-columns 来得到当前列数（随响应式变化）
    if (!destGrid) return 3;
    const style = window.getComputedStyle(destGrid);
    const cols = style.gridTemplateColumns.split(' ').filter(Boolean).length;
    return Math.max(1, cols || 1);
  }

  function computePageSize() {
    const cols = getGridColumns();
    pageSize = cols * 4; // 超过 4 行就分页
  }

  function renderDestinations() {
    if (!destGrid) return;

    computePageSize();
    const filtered = getFilteredIndices();
    const total = filtered.length;
    const totalPages = Math.max(1, Math.ceil(total / pageSize));
    currentPage = Math.min(currentPage, totalPages);

    const start = (currentPage - 1) * pageSize;
    const end = start + pageSize;
    const pageIdx = filtered.slice(start, end);

    if (filterHint) {
      const s = getFilterState();
      const parts = [];
      if (s.city) parts.push(s.city);
      if (s.type) parts.push(s.type);
      if (s.stage) parts.push(s.stage);
      if (s.q) parts.push(`搜索：${s.q}`);
      filterHint.textContent = parts.length ? `已筛选：${parts.join(' / ')}（ 匹配${total} 条）` : `共 ${destinations.length} 个目的地`;
    }

    if (total === 0) {
      destGrid.innerHTML = '<p style="text-align:center;color:#616a77;grid-column:1/-1;padding:18px 0;">没有匹配的目的地，请调整筛选或搜索关键词。</p>';
    } else {
      destGrid.innerHTML = pageIdx.map((realIndex) => {
        const item = destinations[realIndex];
        if (!item) return '';
        return `
      <a class="card-link" href="destination.html?id=${realIndex}" aria-label="查看 ${item.name} 研学手册">
        <div class="card" role="group" aria-label="${item.name}">
          <img src="${item.img}" alt="">
          <div class="card-body">
            <h3>${item.name}</h3>
            <div class="meta">
              <span class="tag">${item.provinceCity}</span>
              <span class="tag">${item.type}</span>
              <span class="tag">适合：${item.stage}</span>
            </div>
            <p class="intro">${buildIntro(item)}</p>
            <div class="themes" aria-label="研学活动主题">
              ${buildThemes(item).map(t => `<span class="theme-tag">${t}</span>`).join('')}
            </div>
          </div>
        </div>
      </a>`;
      }).join('');
    }

    const needPager = total > pageSize;
    if (needPager) {
      destPager.hidden = false;
      pgPrev.disabled = currentPage === 1;
      pgNext.disabled = currentPage === totalPages;
      pgInfo.textContent = `第 ${currentPage} / ${totalPages} 页（ ${total} 个）`;
    } else {
      destPager.hidden = true;
    }
  }

  pgPrev?.addEventListener('click', () => {
    currentPage = Math.max(1, currentPage - 1);
    renderDestinations();
  });
  pgNext?.addEventListener('click', () => {
    currentPage = currentPage + 1;
    renderDestinations();
  });

  // 响应式变化时重新计算列数与分页
  window.addEventListener('resize', () => {
    const prevSize = pageSize;
    computePageSize();
    if (prevSize !== pageSize) {
      currentPage = 1; // 列数变化时回到第一页，避免空页
      renderDestinations();
    }
  });

  // 筛选交互
  function onFilterChange(){
    currentPage = 1;
    renderDestinations();
  }
  filterCity?.addEventListener('change', onFilterChange);
  filterType?.addEventListener('change', onFilterChange);
  filterStage?.addEventListener('change', onFilterChange);
  searchInput?.addEventListener('input', () => {
    // 输入时轻微防抖
    window.__searchTimer && clearTimeout(window.__searchTimer);
    window.__searchTimer = setTimeout(onFilterChange, 120);
  });
  clearFilters?.addEventListener('click', () => {
    if (searchInput) searchInput.value = '';
    if (filterCity) filterCity.value = '';
    if (filterType) filterType.value = '';
    if (filterStage) filterStage.value = '';
    onFilterChange();
  });

  // 首次初始化筛选项与渲染
  initFilters();
  renderDestinations();

</script>

</body>
</html>
